name: Publish Docker Image

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'          # v1.2.3 / v0.9.0 等
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    name: Build and push (${{ matrix.variant }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: cjk
            preload_languages: "ZH,JP,KR"
          # - variant: full
          #   preload_languages: "ZH,JP,KR,EN,FR,ES"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space (aggressive)
        run: |
          echo "Before:"; df -h
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          docker system prune -af --volumes || true
          docker builder prune -af || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          echo "After:"; df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver: docker-container

      - name: Compute image name (lowercase)
        id: vars
        run: |
          IMAGE="$REGISTRY/${{ github.repository }}"
          IMAGE_LC=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')

          REF="${{ github.ref }}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          VARIANT="${{ matrix.variant }}"

          TAGS=""

          if [[ "$REF" == refs/tags/* ]]; then
            GIT_TAG="${REF#refs/tags/}"       # e.g. v1.2.3
            VERSION="${GIT_TAG#v}"            # 1.2.3

            if [[ "$VARIANT" == "full" ]]; then
              TAGS+="$IMAGE_LC:${VERSION}-full"$'\n'
            else
              TAGS+="$IMAGE_LC:${VERSION}"$'\n'
              TAGS+="$IMAGE_LC:${VERSION}-cjk"$'\n'
            fi

            # 生成 semver 系列标签：1.2.3, 1.2, 1
            #MAJOR=$(echo "$VERSION" | cut -d. -f1)
            #MINOR=$(echo "$VERSION" | cut -d. -f2)
            #PATCH=$(echo "$VERSION" | cut -d. -f3)
            #TAGS+="$IMAGE_LC:${MAJOR}.${MINOR}"$'\n'
            #TAGS+="$IMAGE_LC:${MAJOR}"$'\n'
          else
            if [[ "$VARIANT" == "full" ]]; then
              TAGS+="$IMAGE_LC:latest-full"$'\n'
              TAGS+="$IMAGE_LC:full"$'\n'
            else
              TAGS+="$IMAGE_LC:latest"$'\n'
              TAGS+="$IMAGE_LC:cjk"$'\n'
              TAGS+="$IMAGE_LC:latest-cjk"$'\n'
            fi
          fi

          echo "image=$IMAGE_LC" >> $GITHUB_OUTPUT
          printf "tags<<EOF\n%s\nEOF\n" "$TAGS" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata (labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.vars.outputs.image }}
          tags: |
            type=raw,value=manual
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          build-args: |
            PRELOAD_LANGUAGES=${{ matrix.preload_languages }}
          push: true
          tags: ${{ steps.vars.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Prune after build
        if: always()
        run: |
          docker system df
          docker system prune -af --volumes || true
          docker builder prune -af || true
          echo "Disk after prune:"; df -h
